# 数据库设计文档

## 云数据库集合列表

### 1. tenants（租户表）

**用途**：存储机构（租户）信息

**字段**：
- `_id`: ObjectId，主键
- `tenant_id`: String，租户ID（唯一）
- `name`: String，机构名称
- `contact`: String，联系方式
- `address`: String，机构地址
- `status`: String，状态（active/inactive）
- `created_at`: Date，创建时间
- `updated_at`: Date，更新时间

**索引**：
- `tenant_id`: 唯一索引

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null && auth.role == 'admin'"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

### 2. users（用户表）

**用途**：存储用户信息（管理员、教师、家长）

**字段**：
- `_id`: ObjectId，主键
- `user_id`: String，用户ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `openid`: String，微信openid（唯一）
- `role`: String，角色（admin/teacher/parent）
- `name`: String，姓名
- `phone`: String，手机号（加密）
- `avatar`: String，头像URL
- `created_at`: Date，创建时间
- `updated_at`: Date，更新时间

**索引**：
- `tenant_id`: 普通索引
- `openid`: 唯一索引
- `role`: 普通索引
- `{tenant_id: 1, openid: 1}`: 复合索引

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

### 3. students（学生表）

**用途**：存储学生信息

**字段**：
- `_id`: ObjectId，主键
- `student_id`: String，学生ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `parent_openid`: Array，家长openid数组（支持多家长）
- `name`: String，姓名
- `gender`: String，性别（male/female）
- `birth_date`: Date，出生日期
- `grade`: String，年级
- `class`: String，班级
- `school`: String，学校
- `service_type`: Array，服务类型（after_school/full_day/weekend等）
- `status`: String，状态（active/inactive/leave）
- `photo`: String，照片URL
- `emergency_contact`: Object，紧急联系人
  - `name`: String，姓名
  - `phone`: String，电话
- `created_at`: Date，创建时间
- `updated_at`: Date，更新时间

**索引**：
- `tenant_id`: 普通索引
- `parent_openid`: 普通索引
- `status`: 普通索引
- `grade`: 普通索引
- `{tenant_id: 1, student_id: 1}`: 复合索引
- `{tenant_id: 1, parent_openid: 1}`: 复合索引

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

### 4. teachers（教师表）

**用途**：存储教师信息

**字段**：
- `_id`: ObjectId，主键
- `teacher_id`: String，教师ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `user_id`: String，关联用户ID
- `name`: String，姓名
- `phone`: String，手机号（加密）
- `subject`: Array，教授科目
- `status`: String，状态（active/inactive）
- `created_at`: Date，创建时间
- `updated_at`: Date，更新时间

**索引**：
- `tenant_id`: 普通索引
- `user_id`: 普通索引
- `status`: 普通索引

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

### 5. classrooms（教室表）

**用途**：存储教室信息

**字段**：
- `_id`: ObjectId，主键
- `classroom_id`: String，教室ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `name`: String，教室名称
- `location`: String，位置
- `capacity`: Number，容量（最多容纳学生数）
- `equipment`: Array，设备列表
- `status`: String，状态（available/occupied/maintenance）
- `created_at`: Date，创建时间
- `updated_at`: Date，更新时间

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

**索引**：
- `tenant_id`: 普通索引
- `status`: 普通索引

### 6. schedules（课表表）

**用途**：存储课程安排

**字段**：
- `_id`: ObjectId，主键
- `schedule_id`: String，课表ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `course_id`: String，课程ID（外键）
- `teacher_id`: String，教师ID（外键）
- `student_id`: String，学生ID（外键）
- `classroom_id`: String，教室ID（外键）
- `day_of_week`: Number，星期几（1-7）
- `time_slot`: String，时间段（如：14:00-16:00）
- `date`: Date，日期
- `status`: String，状态（scheduled/cancelled/completed）
- `created_at`: Date，创建时间
- `updated_at`: Date，更新时间

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

**索引**：
- `tenant_id`: 普通索引
- `teacher_id`: 普通索引
- `student_id`: 普通索引
- `date`: 普通索引
- `day_of_week`: 普通索引
- `{tenant_id: 1, date: 1, status: 1}`: 复合索引
- `{tenant_id: 1, teacher_id: 1, date: 1}`: 复合索引

### 7. attendance（考勤表）

**用途**：存储考勤记录

**字段**：
- `_id`: ObjectId，主键
- `attendance_id`: String，考勤ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `student_id`: String，学生ID（外键）
- `check_type`: String，打卡类型（checkin/checkout）
- `check_time`: Date，打卡时间
- `location`: Object，位置信息
  - `latitude`: Number，纬度
  - `longitude`: Number，经度
  - `address`: String，地址
- `photo`: String，打卡照片URL
- `check_method`: String，打卡方式（parent/teacher/auto）
- `status`: String，状态（success/failed）
- `created_at`: Date，创建时间

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

**索引**：
- `tenant_id`: 普通索引
- `student_id`: 普通索引
- `check_time`: 普通索引
- `{tenant_id: 1, student_id: 1, check_time: -1}`: 复合索引

### 8. study_reports（学习报告表）

**用途**：存储学习记录和报告

**字段**：
- `_id`: ObjectId，主键
- `report_id`: String，报告ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `student_id`: String，学生ID（外键）
- `teacher_id`: String，教师ID（外键）
- `report_type`: String，报告类型（daily/weekly/monthly）
- `date`: Date，日期
- `homework_completion`: Object，作业完成情况
- `behavior_evaluation`: Object，行为评价
- `photos`: Array，照片URL数组
- `teacher_comment`: String，教师评语
- `parent_feedback`: String，家长反馈
- `created_at`: Date，创建时间
- `updated_at`: Date，更新时间

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

**索引**：
- `tenant_id`: 普通索引
- `student_id`: 普通索引
- `teacher_id`: 普通索引
- `date`: 普通索引
- `{tenant_id: 1, student_id: 1, date: -1}`: 复合索引

### 9. notification_messages（消息表）

**用途**：存储消息记录

**字段**：
- `_id`: ObjectId，主键
- `message_id`: String，消息ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `sender_openid`: String，发送者openid
- `receiver_openid`: String，接收者openid
- `message_type`: String，消息类型（system/notification/chat）
- `title`: String，标题
- `content`: String，内容
- `is_read`: Boolean，是否已读
- `read_at`: Date，阅读时间
- `created_at`: Date，创建时间

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

**索引**：
- `tenant_id`: 普通索引
- `receiver_openid`: 普通索引
- `is_read`: 普通索引
- `{tenant_id: 1, receiver_openid: 1, is_read: 1}`: 复合索引

### 10. audit_logs（审计日志表）

**用途**：存储操作日志

**字段**：
- `_id`: ObjectId，主键
- `log_id`: String，日志ID（唯一）
- `tenant_id`: String，租户ID（外键）
- `openid`: String，用户openid
- `role`: String，用户角色
- `action`: String，操作类型（create/update/delete/read）
- `resource`: String，资源类型
- `resource_id`: String，资源ID
- `before`: Object，修改前的数据
- `after`: Object，修改后的数据
- `ip`: String，IP地址
- `user_agent`: String，用户代理
- `timestamp`: Date，时间戳
- `result`: String，操作结果（success/failure）

**安全规则**（创建时使用）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：先使用基础规则创建集合，后续登录功能完善后再细化权限。

**索引**：
- `tenant_id`: 普通索引
- `openid`: 普通索引
- `timestamp`: 普通索引
- `{tenant_id: 1, timestamp: -1}`: 复合索引

## 数据库安全规则说明

### 创建集合时的规则（简化版）

**所有集合统一使用以下规则创建**（避免语法错误）：
```javascript
{
  "read": "auth != null",
  "write": "auth != null"
}
```

**说明**：
- 这个规则确保只有登录用户才能读写数据
- 先创建集合，后续登录功能完善后再细化权限
- 多租户隔离和角色权限控制会在云函数层面实现

### 后续细化的安全规则（等登录功能完善后）

等用户认证功能完成后，可以按以下规则细化：

#### users（用户表）细化规则：
```javascript
{
  "read": "doc.tenant_id == auth.tenant_id && (auth.openid == doc.openid || auth.role == 'admin' || auth.role == 'teacher')",
  "write": "doc.tenant_id == auth.tenant_id && (auth.openid == doc.openid || auth.role == 'admin')"
}
```

#### students（学生表）细化规则：
```javascript
{
  "read": "doc.tenant_id == auth.tenant_id && (auth.role == 'parent' || auth.role == 'teacher' || auth.role == 'admin')",
  "write": "doc.tenant_id == auth.tenant_id && (auth.role == 'teacher' || auth.role == 'admin')"
}
```

#### tenants（租户表）细化规则：
```javascript
{
  "read": "auth != null",
  "write": "auth != null && auth.role == 'admin'"
}
```

## 创建集合的步骤

### 第一步：创建集合（使用简化规则）

1. 在微信开发者工具的云开发控制台中
2. 进入"数据库"标签
3. 点击"添加集合"
4. 输入集合名称（如：`users`）
5. **权限设置：选择"自定义安全规则"**
6. **粘贴以下规则**：
   ```javascript
   {
     "read": "auth != null",
     "write": "auth != null"
   }
   ```
7. 点击"确定"创建集合

### 第二步：创建索引（可选，后续优化时创建）

1. 点击集合名称进入集合详情
2. 点击"索引"标签
3. 点击"添加索引"
4. 按文档中的索引配置创建

### 第三步：细化安全规则（等登录功能完善后）

1. 点击集合名称进入集合详情
2. 点击"权限设置"
3. 点击"编辑规则"
4. 替换为对应的细化规则
5. 保存

## 注意事项

1. **创建时统一使用简化规则**，避免语法错误
2. **索引可以后续创建**，不影响功能使用
3. **安全规则细化**等登录功能完善后再进行
4. **多租户隔离**主要通过云函数中的 `tenant_id` 过滤实现

